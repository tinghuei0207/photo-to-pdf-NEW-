<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>照片表格 → PDF 產生器</title>

<style>
body{font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif;margin:24px}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
label{display:grid;gap:6px;font-size:14px}
input[type="number"],input[type="text"],select{
padding:8px;border:1px solid #ccc;border-radius:8px;min-width:120px}
input[type="file"]{padding:6px}
button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer}
button.primary{background:#111;color:#fff}
button.secondary{background:#eee}
button:disabled{opacity:.45;cursor:not-allowed}
.preview{margin-top:18px;display:grid;
grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.card{border:1px solid #ddd;border-radius:12px;padding:10px}
.thumb{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px;background:#f5f5f5}
.fn{font-size:12px;margin-top:6px;word-break:break-all}
.bar{margin-top:16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.status{font-size:14px;color:#333}
</style>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>

<body>

<h2>照片 → 表格 → PDF</h2>

<div class="row">
<label>匯入照片
<input id="files" type="file" accept="image/*" multiple>
</label>

<label>PDF 檔名
<input id="fileNameInput" type="text" placeholder="例如：通譯紀錄.pdf">
</label>

<label>每列幾張
<input id="cols" type="number" min="1" max="6" value="3">
</label>

<label>格子寬(mm)
<input id="cellW" type="number" value="55">
</label>

<label>格子高(mm)
<input id="cellH" type="number" value="55">
</label>
</div>

<div class="bar">
<button class="secondary" id="clearBtn">清空</button>
<button class="primary" id="genBtn">產生 PDF</button>
<button class="primary" id="shareBtn" disabled>分享 LINE</button>
<span class="status" id="status"></span>
</div>

<div class="preview" id="preview"></div>

<script>
const filesEl=document.getElementById('files');
const previewEl=document.getElementById('preview');
const statusEl=document.getElementById('status');
const genBtn=document.getElementById('genBtn');
const clearBtn=document.getElementById('clearBtn');
const shareBtn=document.getElementById('shareBtn');

let images=[];
let latestPdfBlob=null;
let latestFileName=null;

function setStatus(msg){statusEl.textContent=msg||'';}

function sanitizeFileName(name){
if(!name)return'photos_table.pdf';
let safe=name.trim().replace(/[\\/:*?"<>|]/g,'-');
if(!safe.toLowerCase().endsWith('.pdf'))safe+='.pdf';
return safe;
}

function isDesktop(){
const ua=navigator.userAgent||'';
return /Win|Mac|Linux/.test(ua)&&!/Android|iPhone|iPad|iPod/.test(ua);
}

function downloadBlob(blob,name){
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;a.download=name;
document.body.appendChild(a);
a.click();
a.remove();
setTimeout(()=>URL.revokeObjectURL(url),60000);
}

function readFile(file){
return new Promise((res,rej)=>{
const fr=new FileReader();
fr.onload=()=>res(fr.result);
fr.onerror=rej;
fr.readAsDataURL(file);
});
}

function resize(dataUrl,maxPx){
return new Promise((res,rej)=>{
const img=new Image();
img.onload=()=>{
const scale=Math.min(1,maxPx/Math.max(img.naturalWidth,img.naturalHeight));
const w=img.naturalWidth*scale;
const h=img.naturalHeight*scale;
const c=document.createElement('canvas');
c.width=w;c.height=h;
c.getContext('2d').drawImage(img,0,0,w,h);
res(c.toDataURL('image/png'));
};
img.onerror=rej;
img.src=dataUrl;
});
}

filesEl.addEventListener('change',async e=>{
const list=Array.from(e.target.files||[]);
for(const f of list){
const d=await readFile(f);
images.push({name:f.name,dataUrl:d});
}
renderPreview();
shareBtn.disabled=true;
latestPdfBlob=null;
filesEl.value='';
});

function renderPreview(){
previewEl.innerHTML='';
for(const i of images){
const div=document.createElement('div');
div.className='card';
div.innerHTML=`<img class="thumb" src="${i.dataUrl}">
<div class="fn">${i.name}</div>`;
previewEl.appendChild(div);
}
}

clearBtn.onclick=()=>{
images=[];
renderPreview();
shareBtn.disabled=true;
latestPdfBlob=null;
setStatus('已清空');
};

genBtn.addEventListener('click',async()=>{
if(!images.length){setStatus('請先匯入照片');return;}

setStatus('生成中...');
shareBtn.disabled=true;

const {jsPDF}=window.jspdf;
const doc=new jsPDF({unit:'mm',format:'a4'});

const cols=parseInt(document.getElementById('cols').value||3);
const cellW=parseInt(document.getElementById('cellW').value||55);
const cellH=parseInt(document.getElementById('cellH').value||55);

const maxPx=Math.max(cellW,cellH)*10;
const resized=[];

for(let i=0;i<images.length;i++){
setStatus(`處理 ${i+1}/${images.length}`);
const d=await resize(images[i].dataUrl,maxPx);
resized.push(d);
}

let x=15,y=15;
let count=0;

for(let i=0;i<resized.length;i++){
doc.addImage(resized[i],'PNG',x,y,cellW,cellH);
x+=cellW+5;
count++;

if(count%cols===0){
x=15;
y+=cellH+10;
if(y+cellH>280){
doc.addPage();
y=15;
}
}
}

const outName=sanitizeFileName(
document.getElementById('fileNameInput').value
);

const blob=doc.output('blob');
latestPdfBlob=blob;
latestFileName=outName;
shareBtn.disabled=false;
setStatus('PDF 已產生');
});

shareBtn.addEventListener('click',async()=>{
if(!latestPdfBlob)return;

if(isDesktop()){
downloadBlob(latestPdfBlob,latestFileName);
setStatus('已下載 PDF，請用 LINE 上傳');
return;
}

if(navigator.share&&navigator.canShare){
try{
const file=new File([latestPdfBlob],latestFileName,{type:'application/pdf'});
if(navigator.canShare({files:[file]})){
await navigator.share({files:[file]});
setStatus('請選 LINE');
return;
}
}catch(e){}
}

downloadBlob(latestPdfBlob,latestFileName);
setStatus('已改為下載');
});
</script>
</body>
</html>
