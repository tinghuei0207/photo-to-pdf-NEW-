<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>照片表格 → PDF 產生器</title>

<style>
body{font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif;margin:24px}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:end}
label{display:grid;gap:6px;font-size:14px}
input[type="number"],input[type="text"],select{
  padding:8px;border:1px solid #ccc;border-radius:8px;min-width:120px
}
input[type="file"]{padding:6px}
button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer}
button.primary{background:#111;color:#fff}
button.secondary{background:#eee}
button.ghost{background:#fff;border:1px solid #ddd}
button:disabled{opacity:.45;cursor:not-allowed}

.preview{margin-top:18px;display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.card{border:1px solid #ddd;border-radius:12px;padding:10px}

/* ✅ 預覽：固定高度 + contain（不裁切、不變形） */
.thumb{
  width:100%;
  height:140px;          /* 想大一點可改 160 */
  object-fit:contain;    /* ✅ 保留原比例 */
  border-radius:10px;
  background:#f5f5f5
}

.fn{font-size:12px;margin-top:6px;word-break:break-all}
.bar{margin-top:16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.status{font-size:14px;color:#333}

/* ✅ LINE 內建瀏覽器提示 */
.notice{
  margin-top:14px;
  border:1px solid #f1d28b;
  background:#fff7e6;
  border-radius:12px;
  padding:12px 12px;
  display:none;
}
.notice h4{margin:0 0 6px 0;font-size:14px}
.notice p{margin:0;font-size:13px;line-height:1.55;color:#333}
.notice .actions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
.kbd{
  display:inline-block;border:1px solid #ddd;border-bottom-width:2px;
  border-radius:6px;padding:2px 6px;background:#fff;font-size:12px
}
.urlBox{
  margin-top:10px;
  background:#fff;border:1px solid #ddd;border-radius:10px;
  padding:10px;font-size:12px;word-break:break-all
}
.small{font-size:12px;color:#555;margin-top:6px}
</style>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>

<body>

<h2>照片 → 表格 → PDF</h2>

<div class="notice" id="lineNotice">
  <h4>LINE 內建瀏覽器限制</h4>
  <p>
    你目前是在 LINE 內建瀏覽器開啟。iOS 在這個環境下通常不會顯示「LINE」作為檔案分享目標，
    因此你按「分享 LINE」看不到 LINE 是正常的。<br>
    ✅ 最穩做法：請點右下角 <span class="kbd">⋯</span> → <b>在 Safari 開啟</b>。<br>
    或者按「複製網址」，到 Safari 貼上開啟。
  </p>

  <div class="urlBox" id="currentUrlBox"></div>
  <div class="small" id="afterClickTip" style="display:none;">
    已嘗試外開。若沒有跳轉，表示被 LINE 擋住：請用右下角 <span class="kbd">⋯</span> 的「在 Safari 開啟」。
  </div>

  <div class="actions">
    <button class="primary" id="openSafariBtn">在 Safari 開啟</button>
    <button class="ghost" id="copyUrlBtn">複製網址</button>
    <button class="secondary" id="hideNoticeBtn">知道了</button>
  </div>
</div>

<div class="row">
  <label>匯入照片
    <input id="files" type="file" accept="image/*" multiple>
  </label>

  <label>PDF 檔名
    <input id="fileNameInput" type="text" placeholder="例如：通譯紀錄.pdf">
  </label>

  <label>每列幾張
    <input id="cols" type="number" min="1" max="6" value="3">
  </label>

  <label>格子寬(mm)
    <input id="cellW" type="number" value="55">
  </label>

  <label>格子高(mm)
    <input id="cellH" type="number" value="55">
  </label>
</div>

<div class="bar">
  <button class="secondary" id="clearBtn">清空</button>
  <button class="primary" id="genBtn">產生 PDF</button>
  <button class="primary" id="shareBtn" disabled>分享 LINE</button>
  <span class="status" id="status"></span>
</div>

<div class="preview" id="preview"></div>

<script>
const filesEl=document.getElementById('files');
const previewEl=document.getElementById('preview');
const statusEl=document.getElementById('status');
const genBtn=document.getElementById('genBtn');
const clearBtn=document.getElementById('clearBtn');
const shareBtn=document.getElementById('shareBtn');

const lineNotice=document.getElementById('lineNotice');
const openSafariBtn=document.getElementById('openSafariBtn');
const copyUrlBtn=document.getElementById('copyUrlBtn');
const hideNoticeBtn=document.getElementById('hideNoticeBtn');
const currentUrlBox=document.getElementById('currentUrlBox');
const afterClickTip=document.getElementById('afterClickTip');

let images=[];
let latestPdfBlob=null;
let latestFileName=null;

function setStatus(msg){statusEl.textContent=msg||'';}

function sanitizeFileName(name){
  if(!name) return 'photos_table.pdf';
  let safe=name.trim().replace(/[\\/:*?"<>|]/g,'-');
  if(!safe.toLowerCase().endsWith('.pdf')) safe+='.pdf';
  return safe;
}

function isDesktop(){
  const ua=navigator.userAgent||'';
  return /Win|Mac|Linux/.test(ua)&&!/Android|iPhone|iPad|iPod/.test(ua);
}

function isLineInApp(){
  const ua=(navigator.userAgent||'').toLowerCase();
  return ua.includes('line');
}

function showLineNotice(){
  currentUrlBox.textContent = location.href;
  lineNotice.style.display='block';
}

function hideLineNotice(){
  lineNotice.style.display='none';
}

async function copyUrl(){
  const url = location.href;
  try{
    await navigator.clipboard.writeText(url);
    setStatus('已複製網址，請到 Safari 貼上開啟');
  }catch(e){
    window.prompt('請長按全選並複製這個網址：', url);
    setStatus('請複製網址後到 Safari 開啟');
  }
}

function openSafariFallbackFirst(){
  showLineNotice();
  afterClickTip.style.display = 'block';

  const url = location.href;
  const w = window.open(url, '_blank');
  if(!w){
    setStatus('LINE 可能阻擋外開：請用右下角 ⋯ → 在 Safari 開啟');
  }else{
    setStatus('已嘗試外開（若沒跳轉請用右下角 ⋯）');
  }
}

openSafariBtn.addEventListener('click', openSafariFallbackFirst);
copyUrlBtn.addEventListener('click', copyUrl);
hideNoticeBtn.addEventListener('click', hideLineNotice);

function downloadBlob(blob,name){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),60000);
}

function readFile(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result);
    fr.onerror=rej;
    fr.readAsDataURL(file);
  });
}

function resize(dataUrl,maxPx){
  return new Promise((res,rej)=>{
    const img=new Image();
    img.onload=()=>{
      const scale=Math.min(1,maxPx/Math.max(img.naturalWidth,img.naturalHeight));
      const w=Math.round(img.naturalWidth*scale);
      const h=Math.round(img.naturalHeight*scale);
      const c=document.createElement('canvas');
      c.width=w;c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      res(c.toDataURL('image/png'));
    };
    img.onerror=rej;
    img.src=dataUrl;
  });
}

filesEl.addEventListener('change',async e=>{
  const list=Array.from(e.target.files||[]);
  for(const f of list){
    const d=await readFile(f);
    images.push({name:f.name,dataUrl:d});
  }
  renderPreview();
  shareBtn.disabled=true;
  latestPdfBlob=null;
  filesEl.value='';
});

function renderPreview(){
  previewEl.innerHTML='';
  for(const i of images){
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`<img class="thumb" src="${i.dataUrl}">
      <div class="fn">${i.name}</div>`;
    previewEl.appendChild(div);
  }
}

clearBtn.onclick=()=>{
  images=[];
  renderPreview();
  shareBtn.disabled=true;
  latestPdfBlob=null;
  setStatus('已清空');
};

genBtn.addEventListener('click',async()=>{
  if(!images.length){setStatus('請先匯入照片');return;}

  setStatus('生成中...');
  shareBtn.disabled=true;

  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({unit:'mm',format:'a4'});

  const cols=parseInt(document.getElementById('cols').value||3,10);
  const cellW=parseInt(document.getElementById('cellW').value||55,10);
  const cellH=parseInt(document.getElementById('cellH').value||55,10);

  const maxPx=Math.max(cellW,cellH)*10;
  const resized=[];

  for(let i=0;i<images.length;i++){
    setStatus(`處理 ${i+1}/${images.length}`);
    const d=await resize(images[i].dataUrl,maxPx);
    resized.push(d);
  }

  let x=15,y=15;
  let count=0;

  // ✅ PDF：固定格子，但圖片等比例縮放置中，不變形
  for (let i = 0; i < resized.length; i++) {
    const imgData = resized[i];

    const props = doc.getImageProperties(imgData);
    const iw = props.width;
    const ih = props.height;

    const scale = Math.min(cellW / iw, cellH / ih);
    const dw = iw * scale;
    const dh = ih * scale;

    const dx = x + (cellW - dw) / 2;
    const dy = y + (cellH - dh) / 2;

    doc.addImage(imgData, 'PNG', dx, dy, dw, dh);

    x += cellW + 5;
    count++;

    if (count % cols === 0) {
      x = 15;
      y += cellH + 10;
      if (y + cellH > 280) {
        doc.addPage();
        y = 15;
      }
    }
  }

  const outName=sanitizeFileName(document.getElementById('fileNameInput').value);

  const rawBlob = doc.output('blob');
  const pdfBlob = new Blob([rawBlob], { type: 'application/pdf' });

  latestPdfBlob=pdfBlob;
  latestFileName=outName;
  shareBtn.disabled=false;
  setStatus('PDF 已產生');
});

function makePdfFile(){
  const safeName = sanitizeFileName(latestFileName || 'photos_table.pdf');
  return new File([latestPdfBlob], safeName, {
    type: 'application/pdf',
    lastModified: Date.now()
  });
}

async function tryNativeShareFile(){
  if(!navigator.share) return false;

  const file = makePdfFile();
  if(navigator.canShare){
    if(!navigator.canShare({ files: [file] })) return false;
  }

  await navigator.share({
    title: file.name,
    text: 'PDF 檔案',
    files: [file]
  });

  return true;
}

shareBtn.addEventListener('click',async()=>{
  if(!latestPdfBlob){ setStatus('請先產生 PDF'); return; }

  if(isLineInApp()){
    showLineNotice();
    setStatus('LINE 內建瀏覽器無法顯示 LINE 分享：請用右下角 ⋯ → 在 Safari 開啟');
    return;
  }

  if(isDesktop()){
    downloadBlob(latestPdfBlob,latestFileName);
    setStatus('已下載 PDF，請用 LINE 上傳');
    return;
  }

  setStatus('嘗試開啟分享面板...');

  try{
    const ok = await tryNativeShareFile();
    if(ok){
      setStatus('請在分享面板選 LINE');
      return;
    }
  }catch(e){}

  downloadBlob(latestPdfBlob,latestFileName);
  setStatus('此裝置/瀏覽器不支援直接分享 PDF，已改為下載');
});

if(isLineInApp()){
  showLineNotice();
}
</script>
</body>
</html>
